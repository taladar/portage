Title: udev upgrade from 197 (or older) to 200 (or newer)
Author: Samuli Suominen <ssuominen@gentoo.org>
Content-Type: text/plain
Posted: 2013-03-29
Revision: 1
News-Item-Format: 1.0
Display-If-Installed: <sys-fs/udev-201

This will replace the earlier news item of udev 197 upgrade,
and describe the predictable networking names to more detail.

If you skip these four phases, either your system won't boot or
networking will be down, or both.
Pay attention also to every message printed by emerge of sys-fs/udev
and sys-fs/udev-init-scripts as this news item may not be complete.

1. Removed init script:

Remove udev-postmount init script from runlevels.

2. DEVTMPFS support, both kernel and fstab:

CONFIG_DEVTMPFS=y kernel option must be enabled (and for that you need
at least kernel 2.6.32) see gentoo udev guide[1] for menuconfig
example.

If you have own line for /dev in /etc/fstab, make sure it's also
fstype 'devtmpfs' and not fstype 'tmpfs' or remove the entire line
since it's automounted without entry there anyway.

[1] http://www.gentoo.org/doc/en/udev-guide.xml

3. Old networking rules:

If the system still has old network interface renaming rules in
/etc/udev/rules.d, like 70-persistent-net.rules, those will need
to be either modified or removed.

If you choose to modify them, you must use free namespace (like net*
or internet*) instead of kernel namespace (like eth* or wlan*)
because in-place renaming has been deprecated, see small
documentation of it if you like[1]

The file 70-persistent-net.rules, like the 70-persistent-cd.rules
should be removed, so if you modify, rename the file also to something
else like 70-my-network.rules to silence the deprecation warning coming
from end of sys-fs/udev emerge.

This is the old format with reserved namespace:

SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="xx:xx:xx:xx:xx:xx",
NAME="eth0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="yy:yy:yy:yy:yy:yy",
NAME="eth1"

This is the new format with free namespace:

SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="xx:xx:xx:xx:xx:xx",
NAME="net0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="yy:yy:yy:yy:yy:yy",
NAME="net1"

4. The predictable network interface naming:

If /etc/udev/rules.d/80-net-name-slot.rules is a empty file, or if it's
a symlink to /dev/null, the new names will be disabled and kernel will
do all the interface naming, and the resulting names will vary by kernel
and hardware configuration, and may vary by kernel version.

Also, the forementioned old 70-persistent-net.rules might interfere with
the new enabling of the new predictable interface names!

You can get attributes of your networking interfaces using following
example command (replace eth0 with your current interface name):

# udevadm test-builtin net_id /sys/class/net/eth0 2> /dev/null

You can copy /lib/udev/rules.d/80-net-name-slot.rules to
/etc/udev/rules.d and specify what attributes and in which order
gets used for naming. See upstream wiki[2] for detailed list
of options.

You can prepare the system this way for the new names before booting,
like renaming /etc/init.d/net.* symlinks.

The feature can also be completely disabled using net.ifnames=0 kernel
commandline option.

If you only have one interface card, you don't necessarily have much
use for this feature as the name almost always stays at eth0, you can
easily disable it using forementioned methods.

In a normal new installation there are no files in /etc/udev/rules.d
and if you haven't edited any files you have in there, you should most
likely backup and delete them all if they don't belong to any packages.

This feature can also replace the functionality of sys-apps/biosdevname,
but you can still keep using it if you want.

The official wiki has dedicated page for udev upgrade notes[3].

[1] http://www.kernel.org/doc/htmldocs/device-drivers/
    API-device-rename.html
[2] http://www.freedesktop.org/wiki/Software/systemd/
    PredictableNetworkInterfaceNames
[3] http://wiki.gentoo.org/wiki/Udev/upgrade
